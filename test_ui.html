<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Management API Test UI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .section h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .section h3 {
            color: #555;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.success {
            background-color: #28a745;
        }
        button.success:hover {
            background-color: #1e7e34;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.danger:hover {
            background-color: #c82333;
        }
        button.warning {
            background-color: #ffc107;
            color: #212529;
        }
        button.warning:hover {
            background-color: #e0a800;
        }
        button:disabled {
            background-color: #cccccc !important;
            color: #666666 !important;
            cursor: not-allowed !important;
            transform: none !important;
        }
        button:disabled:hover {
            background-color: #cccccc !important;
            transform: none !important;
        }
        input, select, textarea {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        label {
            display: inline-block;
            margin: 10px 0 5px 0;
            font-weight: bold;
        }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            overflow-x: auto;
            max-height: 300px;
        }
        .character-card {
            border: 1px solid #007bff;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            background-color: white;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status-warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }
                 .script-item {
             border: 1px solid #ddd;
             padding: 15px;
             margin: 10px 0;
             border-radius: 5px;
             background-color: white;
         }
         .dialogue-line-editor {
             border: 1px solid #ccc;
             padding: 15px;
             margin: 10px 0;
             border-radius: 5px;
             background-color: #f9f9f9;
         }
         .dialogue-line-editor.editing {
             border-color: #007bff;
             background-color: #e7f3ff;
         }
         .speaker-select {
             width: 150px;
             margin-right: 10px;
         }
         .dialogue-text-input {
             width: 100%;
             min-height: 60px;
             margin: 10px 0;
         }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≠ Character Management API Test UI</h1>
        
        <!-- System Status Section -->
        <div class="section">
            <h2>üöÄ System Status</h2>
            <button onclick="getSystemStatus()">üîÑ Refresh System Status</button>
            <div id="systemStatus">
                <div class="status-warning">
                    <p>Click "Refresh System Status" to check system health</p>
                </div>
            </div>
        </div>
        
        <!-- List Characters Section -->
        <div class="section">
            <h2>üë• Characters List</h2>
            <button onclick="listCharacters()">üîÑ Refresh Characters List</button>
            <div id="charactersList">
                <div class="status-warning">
                    <p>Click "Refresh Characters List" to load characters</p>
                </div>
            </div>
        </div>
        
        <!-- Create Complete Character Section -->
        <div class="section">
            <h2>‚ûï Create New Character (Complete)</h2>
            <p><strong>All-in-One:</strong> Create character with name, config, audio file, and images in one step!</p>
            
            <form id="createCompleteCharacterForm">
                <div class="form-group">
                    <h4>üìù Basic Information</h4>
                    <label>Display Name:</label>
                    <input type="text" id="completeDisplayName" required placeholder="e.g., John Doe" style="width: 300px;">
                </div>
                
                <div class="form-group">
                    <h4>üéµ Audio File (Required)</h4>
                    <label>Audio File:</label>
                    <input type="file" id="completeAudioFile" accept=".wav,.mp3,.m4a,.flac,.ogg" required>
                    <br><small>Supported formats: WAV, MP3, M4A, FLAC, OGG (Max 50MB)</small>
                </div>
                
                <div class="form-group">
                    <h4>üñºÔ∏è Images (Required - Max 10)</h4>
                    <label>Image Files:</label>
                    <input type="file" id="completeImageFiles" accept=".png,.jpg,.jpeg,.webp" multiple required>
                    <br><small>Supported formats: PNG, JPG, JPEG, WEBP (Max 10MB each)</small>
                </div>
                
                <div class="form-group">
                    <h4>‚öôÔ∏è Configuration (Optional - Leave empty for defaults)</h4>
                                         <div class="form-row">
                         <label>Speed:</label>
                         <input type="number" id="completeSpeed" step="0.1" min="0.5" max="2.0" placeholder="1.0">
                         
                         <label>NFE Steps:</label>
                         <input type="number" id="completeNfeSteps" min="20" max="50" placeholder="34">
                     </div>
                     <div class="form-row">
                         <label>Cross Fade Duration:</label>
                         <input type="number" id="completeCrossFadeDuration" step="0.01" min="0" max="1" placeholder="0.15">
                         
                         <label>Remove Silences:</label>
                         <input type="checkbox" id="completeRemoveSilences" checked>
                     </div>
                </div>
                
                <button type="submit" class="success" style="padding: 15px 30px; font-size: 16px;">
                    ‚ú® Create Complete Character
                </button>
            </form>
            <div id="createCompleteCharacterResult"></div>
        </div>
        
        <!-- Update Character Section -->
        <div class="section">
            <h2>‚úèÔ∏è Update Character</h2>
            <form id="updateCharacterForm">
                <div class="form-group">
                    <label>Character ID:</label>
                    <input type="text" id="updateCharacterId" required placeholder="e.g., palki" style="width: 200px;">
                    
                    <label>New Display Name:</label>
                    <input type="text" id="updateDisplayName" placeholder="Leave empty to keep current" style="width: 200px;">
                </div>
                
                <div class="form-group">
                    <h4>‚öôÔ∏è Update Configuration (Optional)</h4>
                                         <div class="form-row">
                         <label>Speed:</label>
                         <input type="number" id="updateSpeed" step="0.1" min="0.5" max="2.0" placeholder="1.0">
                         
                         <label>NFE Steps:</label>
                         <input type="number" id="updateNfeSteps" min="20" max="50" placeholder="34">
                     </div>
                     <div class="form-row">
                         <label>Cross Fade Duration:</label>
                         <input type="number" id="updateCrossFadeDuration" step="0.01" min="0" max="1" placeholder="0.15">
                         
                         <label>Remove Silences:</label>
                         <select id="updateRemoveSilences">
                             <option value="">Keep current</option>
                             <option value="true">True</option>
                             <option value="false">False</option>
                         </select>
                     </div>
                </div>
                
                <button type="submit" class="warning">üìù Update Character</button>
            </form>
            <div id="updateCharacterResult"></div>
        </div>
        
        <!-- Get Character Details Section -->
        <div class="section">
            <h2>üîç Get Character Details</h2>
            <form id="getCharacterForm">
                <div class="form-row">
                    <label>Character ID:</label>
                    <input type="text" id="getCharacterId" required placeholder="e.g., palki" style="width: 200px;">
                    <button type="submit">üîç Get Character</button>
                </div>
            </form>
            <div id="getCharacterResult"></div>
        </div>
        
        <!-- Delete Character Section -->
        <div class="section">
            <h2>üóëÔ∏è Delete Character</h2>
            <form id="deleteCharacterForm">
                <div class="form-row">
                    <label>Character ID:</label>
                    <input type="text" id="deleteCharacterId" required placeholder="e.g., testuser" style="width: 200px;">
                    <button type="submit" class="danger">üóëÔ∏è Delete Character</button>
                </div>
            </form>
            <div id="deleteCharacterResult"></div>
        </div>
        
        <!-- F5-TTS Status Section -->
        <div class="section">
            <h2>üé§ F5-TTS Service Status</h2>
            <button onclick="checkF5TTSStatus()">üîÑ Check F5-TTS Status</button>
            <div id="f5ttsStatus">
                <div class="status-warning">
                    <p>Click "Check F5-TTS Status" to verify TTS service</p>
                </div>
            </div>
        </div>
        
        <!-- Script Creation Section -->
        <div class="section">
            <h2>üìù Script Creation & Audio Generation</h2>
            
            <!-- Scripts List -->
            <div class="form-group">
                <h3>üìã Scripts</h3>
                <button onclick="listScripts()">üîÑ Refresh Scripts</button>
                <div id="scripts-list">
                    <div class="status-warning">
                        <p>Click "Refresh Scripts" to load existing scripts</p>
                    </div>
                </div>
            </div>
            
            <!-- Generate New Script -->
            <div class="form-group">
                <h3>‚ú® Generate New Script</h3>
                <form id="generate-script-form">
                    <div class="form-group">
                        <label>Selected Characters (hold Ctrl for multiple):</label>
                        <select id="script-characters" multiple required style="width: 100%; height: 120px;">
                            <option disabled>Loading characters...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Prompt:</label>
                        <textarea id="script-prompt" required placeholder="Enter the topic or situation for the dialogue..." style="width: 100%; height: 80px;"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Word (optional):</label>
                        <input type="text" id="script-word" placeholder="Enter a word to explain (optional)" style="width: 100%;">
                    </div>
                    
                                         <button type="submit" class="success">‚ú® Generate Script</button>
                 </form>
                 <div id="generateScriptResult"></div>
             </div>

                         <!-- Script Editing Section -->
             <div class="form-group">
                 <h3>‚úèÔ∏è Edit Script</h3>
                 <div id="script-editor" style="display: none;">
                     <div class="status-warning">
                         <p><strong>Editing Script:</strong> <span id="editing-script-id"></span></p>
                         <button onclick="cancelScriptEdit()" class="danger">‚ùå Cancel Edit</button>
                     </div>
                     
                     <div id="script-dialogue-editor">
                         <!-- Dialogue lines will be populated here -->
                     </div>
                     
                     <div style="margin-top: 20px;">
                         <button onclick="saveScriptChanges()" class="success">üíæ Save Changes</button>
                         <button onclick="addDialogueLine()" class="warning">‚ûï Add Line</button>
                         <button onclick="cancelScriptEdit()" class="danger">‚ùå Cancel</button>
                     </div>
                 </div>
                 <div id="script-edit-result"></div>
             </div>

             <!-- Video Generation Section -->
             <div class="form-group">
                 <h3>üé¨ Video Generation</h3>
                 <div id="video-status">
                     <div class="status-warning">
                         <p>Generate a script first, then you can create audio and video</p>
                     </div>
                 </div>
                 <div id="video-controls"></div>
             </div>
         </div>
     </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        
        // Function to check if we're running from file:// protocol
        function isFileProtocol() {
            return window.location.protocol === 'file:';
        }
        
        // Enhanced fetch with better error handling
        async function safeFetch(url, options = {}) {
            if (isFileProtocol()) {
                console.warn('‚ö†Ô∏è Running from file:// protocol. Please use HTTP server for full functionality.');
                console.log('üí° Run: python -m http.server 3000 and open http://localhost:3000/test_ui.html');
            }
            
            try {
                const response = await fetch(url, options);
                return response;
            } catch (error) {
                if (isFileProtocol()) {
                    throw new Error(`CORS Error: Please serve this file over HTTP. Run 'python -m http.server 3000' and open http://localhost:3000/test_ui.html`);
                }
                throw error;
            }
        }
        
        function displayResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            const className = isError ? 'status-error' : 'status-success';
            if (typeof data === 'object') {
                element.innerHTML = `<div class="${className}"><pre>${JSON.stringify(data, null, 2)}</pre></div>`;
            } else {
                element.innerHTML = `<div class="${className}"><p>${data}</p></div>`;
            }
        }
        
        async function getSystemStatus() {
            try {
                document.getElementById('systemStatus').innerHTML = '<div class="status-warning"><p>üîÑ Checking system status...</p></div>';
                
                // Check API status
                const apiResponse = await safeFetch(`${API_BASE}/system/status`);
                const apiStatus = await apiResponse.json();
                
                // Check F5-TTS status
                const f5ttsResponse = await safeFetch(`${API_BASE}/f5tts/status`);
                const f5ttsStatus = await f5ttsResponse.json();
                
                // Check FFmpeg status
                const ffmpegResponse = await safeFetch(`${API_BASE}/system/ffmpeg-status`);
                const ffmpegStatus = await ffmpegResponse.json();
                
                const statusHtml = `
                    <div class="status-success">
                        <h4>üöÄ System Status - All Good!</h4>
                        <p><strong>üîß API:</strong> ${apiStatus.status} (${apiStatus.totalCharacters} characters loaded)</p>
                        <p><strong>üé§ F5-TTS:</strong> ${f5ttsStatus.status} (${f5ttsStatus.url})</p>
                        <p><strong>üé¨ FFmpeg:</strong> ${ffmpegStatus.status} - ${ffmpegStatus.message}</p>
                        <p><strong>üìÅ Data Directory:</strong> ${apiStatus.apiDataDir}</p>
                        <p><strong>‚è∞ Last Check:</strong> ${new Date().toLocaleString()}</p>
                    </div>
                `;
                
                document.getElementById('systemStatus').innerHTML = statusHtml;
            } catch (error) {
                document.getElementById('systemStatus').innerHTML = `
                    <div class="status-error">
                        <h4>‚ùå System Status Check Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Possible causes:</strong></p>
                        <ul>
                            <li>API server is not running (run: python app.py)</li>
                            <li>CORS issues (try running from localhost)</li>
                            <li>Network connectivity problems</li>
                        </ul>
                        <p><strong>‚è∞ Failed at:</strong> ${new Date().toLocaleString()}</p>
                    </div>
                `;
            }
        }
        async function listCharacters() {
            try {
                document.getElementById('charactersList').innerHTML = '<div class="status-warning"><p>üîÑ Loading characters...</p></div>';
                
                const response = await fetch(`${API_BASE}/characters`);
                const data = await response.json();
                
                if (data.length === 0) {
                    document.getElementById('charactersList').innerHTML = `
                        <div class="status-warning">
                            <h4>üì≠ No Characters Found</h4>
                            <p>Create your first character using the form below!</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="status-success"><h4>üë• Characters Loaded Successfully</h4></div>';
                data.forEach(char => {
                    html += `
                        <div class="character-card">
                            <h4>üé≠ ${char.displayName} (${char.id})</h4>
                            <div class="form-row">
                                <span><strong>üéµ Audio:</strong> ${char.hasAudio ? '‚úÖ Available' : '‚ùå Missing'}</span>
                                <span><strong>üñºÔ∏è Images:</strong> ${char.imageCount} files</span>
                            </div>
                            <div class="form-row">
                                <span><strong>‚ö° Speed:</strong> ${char.config.speed}x</span>
                                <span><strong>üîß NFE Steps:</strong> ${char.config.nfeSteps}</span>
                                <span><strong>üîÄ Cross Fade:</strong> ${char.config.crossFadeDuration}s</span>
                            </div>
                            <p><strong>üìÖ Created:</strong> ${new Date(char.createdAt).toLocaleString()}</p>
                        </div>
                    `;
                });
                document.getElementById('charactersList').innerHTML = html;
                
                // Also populate script character selection
                loadCharactersForSelection(data);
            } catch (error) {
                document.getElementById('charactersList').innerHTML = `
                    <div class="status-error">
                        <h4>‚ùå Failed to Load Characters</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Make sure the API server is running and accessible.</p>
                    </div>
                `;
            }
        }

        function loadCharactersForSelection(characters) {
            const selectionDiv = document.getElementById('script-characters');
            selectionDiv.innerHTML = '';
            
            characters.forEach(char => {
                const option = document.createElement('option');
                option.value = char.id;
                option.textContent = `${char.displayName} (${char.id})`;
                
                selectionDiv.appendChild(option);
            });
        }

        // Alias for backward compatibility
        async function loadCharacters() {
            await listCharacters();
        }
        document.getElementById('createCompleteCharacterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const displayName = document.getElementById('completeDisplayName').value;
            const speed = document.getElementById('completeSpeed').value;
            const nfeSteps = document.getElementById('completeNfeSteps').value;
            const crossFadeDuration = document.getElementById('completeCrossFadeDuration').value;
            const removeSilences = document.getElementById('completeRemoveSilences').checked;
            const audioFile = document.getElementById('completeAudioFile').files[0];
            const imageFiles = document.getElementById('completeImageFiles').files;
            
            if (!displayName.trim()) {
                displayResult('createCompleteCharacterResult', { error: 'Display name is required' });
                return;
            }
            
            if (!audioFile) {
                displayResult('createCompleteCharacterResult', { error: 'Audio file is required' });
                return;
            }
            
            if (imageFiles.length === 0) {
                displayResult('createCompleteCharacterResult', { error: 'At least one image file is required' });
                return;
            }
            
            if (imageFiles.length > 10) {
                displayResult('createCompleteCharacterResult', { error: 'Maximum 10 images allowed' });
                return;
            }
            
            const formData = new FormData();
            formData.append('displayName', displayName.trim());
            formData.append('removeSilences', removeSilences.toString());
            
            if (speed) formData.append('speed', speed);
            if (nfeSteps) formData.append('nfeSteps', nfeSteps);
            if (crossFadeDuration) formData.append('crossFadeDuration', crossFadeDuration);
            
            formData.append('audioFile', audioFile);
            
            for (let i = 0; i < imageFiles.length; i++) {
                formData.append('imageFiles', imageFiles[i]);
            }
            
            displayResult('createCompleteCharacterResult', { status: 'Creating character... Please wait.' });
            
            try {
                const response = await fetch(`${API_BASE}/characters/complete`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                displayResult('createCompleteCharacterResult', data);
                
                if (response.ok) {
                    document.getElementById('createCompleteCharacterForm').reset();
                    listCharacters();
                    alert(`Successfully created character: ${data.displayName} (ID: ${data.id})`);
                } else {
                    alert(`Failed to create character: ${data.detail || 'Unknown error'}`);
                }
            } catch (error) {
                const errorData = { error: error.message };
                displayResult('createCompleteCharacterResult', errorData);
                alert(`Error creating character: ${error.message}`);
            }
        });
        document.getElementById('updateCharacterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const characterId = document.getElementById('updateCharacterId').value;
            const displayName = document.getElementById('updateDisplayName').value;
            const speed = document.getElementById('updateSpeed').value;
            const nfeSteps = document.getElementById('updateNfeSteps').value;
            const crossFadeDuration = document.getElementById('updateCrossFadeDuration').value;
            const removeSilences = document.getElementById('updateRemoveSilences').value;
            
            const payload = {};
            
            if (displayName) payload.displayName = displayName;
            
            if (speed || nfeSteps || crossFadeDuration || removeSilences) {
                payload.config = {};
                if (speed) payload.config.speed = parseFloat(speed);
                if (nfeSteps) payload.config.nfeSteps = parseInt(nfeSteps);
                if (crossFadeDuration) payload.config.crossFadeDuration = parseFloat(crossFadeDuration);
                if (removeSilences) payload.config.removeSilences = removeSilences === 'true';
            }
            
            try {
                const response = await fetch(`${API_BASE}/characters/${characterId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                displayResult('updateCharacterResult', data);
                
                if (response.ok) {
                    listCharacters();
                }
            } catch (error) {
                displayResult('updateCharacterResult', { error: error.message });
            }
        });
        document.getElementById('getCharacterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const characterId = document.getElementById('getCharacterId').value;
            
            try {
                const response = await fetch(`${API_BASE}/characters/${characterId}`);
                const data = await response.json();
                displayResult('getCharacterResult', data);
            } catch (error) {
                displayResult('getCharacterResult', { error: error.message });
            }
        });
        document.getElementById('deleteCharacterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const characterId = document.getElementById('deleteCharacterId').value;
            
            if (!confirm(`Are you sure you want to delete character '${characterId}'? This will also delete all associated files.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/characters/${characterId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                displayResult('deleteCharacterResult', data);
                
                if (response.ok) {
                    document.getElementById('deleteCharacterForm').reset();
                    listCharacters();
                }
            } catch (error) {
                displayResult('deleteCharacterResult', { error: error.message });
            }
        });

        async function checkF5TTSStatus() {
            try {
                document.getElementById('f5ttsStatus').innerHTML = '<div class="status-warning"><p>üîÑ Checking F5-TTS service...</p></div>';
                
                const response = await fetch(`${API_BASE}/f5tts/status`);
                const data = await response.json();
                
                const statusHtml = `
                    <div class="status-success">
                        <h4>üé§ F5-TTS Service Status</h4>
                        <p><strong>Status:</strong> ${data.status === 'connected' ? '‚úÖ Connected' : '‚ùå Disconnected'}</p>
                        <p><strong>URL:</strong> ${data.url}</p>
                        <p><strong>Last Check:</strong> ${new Date(data.timestamp).toLocaleString()}</p>
                    </div>
                `;
                
                document.getElementById('f5ttsStatus').innerHTML = statusHtml;
            } catch (error) {
                document.getElementById('f5ttsStatus').innerHTML = `
                    <div class="status-error">
                        <h4>‚ùå F5-TTS Service Check Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Make sure F5-TTS service is running on the expected port.</p>
                    </div>
                `;
            }
        }

        // Script Management Functions
        let availableCharacters = [];
        let currentScript = null;

        async function loadCharactersForSelection() {
            try {
                const response = await fetch(`${API_BASE}/characters`);
                const characters = await response.json();
                availableCharacters = characters;
                
                const selectionDiv = document.getElementById('script-characters');
                selectionDiv.innerHTML = '';
                
                characters.forEach(char => {
                    const option = document.createElement('option');
                    option.value = char.id;
                    option.textContent = ` ${char.displayName} (${char.id})`;
                    
                    selectionDiv.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading characters:', error);
            }
        }

        function getSelectedCharacters() {
            const selectedOptions = document.getElementById('script-characters').selectedOptions;
            return Array.from(selectedOptions).map(option => option.value);
        }

        document.getElementById('generate-script-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const selectedCharacters = getSelectedCharacters();
            const prompt = document.getElementById('script-prompt').value.trim();
            const word = document.getElementById('script-word').value.trim();
            
            if (selectedCharacters.length < 2 || selectedCharacters.length > 5) {
                displayResult('generateScriptResult', { error: 'Please select 2-5 characters' });
                return;
            }
            
            if (!prompt) {
                displayResult('generateScriptResult', { error: 'Please enter a situation/prompt' });
                return;
            }
            
            const payload = {
                selectedCharacters: selectedCharacters,
                prompt: prompt,
                word: word || null
            };
            
            displayResult('generateScriptResult', { status: 'Generating script... Please wait.' });
            
            try {
                const response = await fetch(`${API_BASE}/scripts/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                displayResult('generateScriptResult', data);
                
                if (response.ok) {
                    document.getElementById('generate-script-form').reset();
                    listScripts();
                    alert(`Successfully generated script: ${data.id}`);
                } else {
                    alert(`Failed to generate script: ${data.detail || 'Unknown error'}`);
                }
            } catch (error) {
                const errorData = { error: error.message };
                displayResult('generateScriptResult', errorData);
                alert(`Error generating script: ${error.message}`);
            }
        });

        async function listScripts() {
            try {
                document.getElementById('scripts-list').innerHTML = '<div class="status-warning"><p>üîÑ Loading scripts...</p></div>';
                
                const response = await fetch(`${API_BASE}/scripts`);
                const scripts = await response.json();
                
                if (scripts.length === 0) {
                    document.getElementById('scripts-list').innerHTML = `
                        <div class="status-warning">
                            <h4>üìù No Scripts Found</h4>
                            <p>Generate your first script using the form above!</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="status-success"><h4>üìã Scripts Loaded Successfully</h4></div>';
                scripts.forEach(script => {
                    const audioInfo = script.hasAudio ? 
                        `‚úÖ Audio: ${script.audioCount}/${script.dialogue.length} lines` : 
                        '‚ùå No audio generated';
                    
                    const videoInfo = script.finalVideoPath ? 
                        `‚úÖ Video: ${script.finalVideoPath}` : 
                        '‚è≥ No video generated';
                    
                    html += `
                        <div class="script-item">
                            <h4>üìù Script: ${script.id}</h4>
                            <div class="form-row">
                                <span><strong>üë• Characters:</strong> ${script.selectedCharacters.join(', ')}</span>
                                <span><strong>üí¨ Lines:</strong> ${script.dialogue.length}</span>
                            </div>
                            <p><strong>üí° Prompt:</strong> ${script.originalPrompt}</p>
                            ${script.word ? `<p><strong>üìñ Word:</strong> ${script.word}</p>` : ''}
                            <div class="form-row">
                                <span><strong>üéµ Audio:</strong> ${audioInfo}</span>
                                <span><strong>üé¨ Video:</strong> ${videoInfo}</span>
                            </div>
                            <p><strong>üìÖ Created:</strong> ${new Date(script.createdAt).toLocaleString()}</p>
                            
                            <div style="margin-top: 15px;">
                                <button onclick="viewScriptDetails('${script.id}')" class="warning">üëÅÔ∏è View Details</button>
                                <button onclick="editScript('${script.id}')" style="background-color: #6f42c1; color: white;">‚úèÔ∏è Edit Script</button>
                                <button onclick="deleteScript('${script.id}')" class="danger">üóëÔ∏è Delete</button>
                                
                                <button onclick="generateAudioForScript('${script.id}')" class="success" ${script.audioCount === script.dialogue.length ? 'disabled title="All audio files already generated"' : ''}>
                                    üé§ Generate Audio ${script.audioCount === script.dialogue.length ? '(Complete)' : `(${script.audioCount}/${script.dialogue.length})`}
                                </button>
                                
                                <button onclick="generateVideoForScript('${script.id}')" style="background-color: #2196F3; color: white;" ${script.audioCount < script.dialogue.length ? 'disabled title="Generate all audio files first"' : ''}>
                                    üé¨ Generate Video
                                </button>
                                
                                ${script.finalVideoPath ? 
                                    `<button onclick="viewVideoDetails('${script.id}')" class="warning">üé• View Video</button>` : 
                                    ''}
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('scripts-list').innerHTML = html;
            } catch (error) {
                document.getElementById('scripts-list').innerHTML = `
                    <div class="status-error">
                        <h4>‚ùå Failed to Load Scripts</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Make sure the API server is running and accessible.</p>
                    </div>
                `;
            }
        }

        async function viewScriptDetails(scriptId) {
            try {
                const response = await fetch(`${API_BASE}/scripts/${scriptId}`);
                const script = await response.json();
                
                let dialogueHtml = '';
                script.dialogue.forEach((line, index) => {
                    const audioStatus = line.audioFile ? '‚úÖ' : '‚ùå';
                    dialogueHtml += `
                        <div style="margin: 5px 0; padding: 5px; border-left: 3px solid #ddd;">
                            <strong>${line.speaker}:</strong> ${line.text}
                            <br><small>Audio: ${audioStatus} ${line.audioFile || 'No audio file'}</small>
                        </div>
                    `;
                });
                
                const detailsHtml = `
                    <h3>Script Details: ${script.id}</h3>
                    <p><strong>Characters:</strong> ${script.selectedCharacters.join(', ')}</p>
                    <p><strong>Prompt:</strong> ${script.originalPrompt}</p>
                    ${script.word ? `<p><strong>Word:</strong> ${script.word}</p>` : ''}
                    <p><strong>Audio Count:</strong> ${script.audioCount}/${script.dialogue.length}</p>
                    ${script.finalVideoPath ? `<p><strong>Final Video:</strong> ${script.finalVideoPath}</p>` : ''}
                    <p><strong>Created:</strong> ${new Date(script.createdAt).toLocaleString()}</p>
                    <h4>Dialogue:</h4>
                    ${dialogueHtml}
                `;
                
                alert(detailsHtml.replace(/<[^>]*>/g, '\n').replace(/\n\n+/g, '\n'));
            } catch (error) {
                alert(`Error viewing script details: ${error.message}`);
            }
        }

        async function generateAudioForScript(scriptId) {
            try {
                document.getElementById('video-status').innerHTML = `
                    <div class="status-warning">
                        <p>üé§ Generating audio for script: ${scriptId}...</p>
                        <p>‚è≥ This may take a few minutes depending on the number of dialogue lines...</p>
                        <p>üîÑ The system will only generate audio for lines that don't already have audio files.</p>
                    </div>
                `;
                
                const response = await fetch(`${API_BASE}/scripts/${scriptId}/generate-audio`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('video-status').innerHTML = `
                        <div class="status-success">
                            <h4>‚úÖ Audio Generation Complete!</h4>
                            <p><strong>Status:</strong> ${result.message}</p>
                            <p><strong>Completed:</strong> ${result.completedLines}/${result.totalLines} lines</p>
                            <p><strong>Script:</strong> ${scriptId}</p>
                        </div>
                    `;
                    listScripts(); // Refresh the scripts list
                } else {
                    document.getElementById('video-status').innerHTML = `
                        <div class="status-error">
                            <h4>‚ùå Audio Generation Failed</h4>
                            <p><strong>Error:</strong> ${result.detail}</p>
                            <p><strong>Script:</strong> ${scriptId}</p>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('video-status').innerHTML = `
                    <div class="status-error">
                        <h4>‚ùå Audio Generation Error</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Script:</strong> ${scriptId}</p>
                    </div>
                `;
            }
        }

        async function generateVideoForScript(scriptId) {
            try {
                document.getElementById('video-status').innerHTML = `
                    <div class="status-warning">
                        <h4>üé¨ Video Generation Started</h4>
                        <p><strong>Script:</strong> ${scriptId}</p>
                        <p>‚è≥ This may take several minutes depending on the script length...</p>
                        <p>üéôÔ∏è Initializing subtitle generation...</p>
                        <p>üéµ Processing audio files...</p>
                        <p>üé• Generating final video with FFmpeg...</p>
                    </div>
                `;
                document.getElementById('video-controls').innerHTML = `
                    <p style="font-style: italic;">üîÑ Video generation in progress... Please wait.</p>
                `;
                
                const response = await fetch(`${API_BASE}/scripts/${scriptId}/generate-video`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('video-status').innerHTML = `
                        <div class="status-success">
                            <h4>‚úÖ Video Generation Complete!</h4>
                            <p><strong>Status:</strong> ${result.message}</p>
                            <p><strong>Final Video:</strong> ${result.finalVideoPath}</p>
                            <p><strong>Duration:</strong> ${result.duration ? result.duration.toFixed(2) + 's' : 'Unknown'}</p>
                            <p><strong>Script:</strong> ${scriptId}</p>
                        </div>
                    `;
                    document.getElementById('video-controls').innerHTML = `
                        <button onclick="viewVideoDetails('${scriptId}')" style="background-color: #FF9800; color: white;">üé• View Video Details</button>
                        <button onclick="checkVideoStatus('${scriptId}')" class="warning">üìä Check Status</button>
                        <button onclick="listScripts()" class="success">üîÑ Refresh Scripts</button>
                    `;
                    listScripts(); // Refresh the scripts list
                } else {
                    document.getElementById('video-status').innerHTML = `
                        <div class="status-error">
                            <h4>‚ùå Video Generation Failed</h4>
                            <p><strong>Error:</strong> ${result.detail}</p>
                            <p><strong>Script:</strong> ${scriptId}</p>
                        </div>
                    `;
                    document.getElementById('video-controls').innerHTML = `
                        <button onclick="checkVideoStatus('${scriptId}')" class="warning">üìä Check Status</button>
                        <button onclick="listScripts()" class="success">üîÑ Refresh Scripts</button>
                    `;
                }
            } catch (error) {
                document.getElementById('video-status').innerHTML = `
                    <div class="status-error">
                        <h4>‚ùå Video Generation Error</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Script:</strong> ${scriptId}</p>
                    </div>
                `;
                document.getElementById('video-controls').innerHTML = `
                    <button onclick="listScripts()" class="success">üîÑ Refresh Scripts</button>
                `;
            }
        }

        async function checkVideoStatus(scriptId) {
            try {
                const response = await fetch(`${API_BASE}/scripts/${scriptId}/video-status`);
                const status = await response.json();
                
                document.getElementById('video-status').innerHTML = `
                    <h4>Video Status for ${scriptId}</h4>
                    <p><strong>Status:</strong> ${status.status}</p>
                    <p><strong>Stage:</strong> ${status.stage}</p>
                    <p><strong>Progress:</strong> ${status.progress}%</p>
                    <p><strong>Message:</strong> ${status.message}</p>
                    ${status.finalVideoPath ? `<p><strong>Final Video:</strong> ${status.finalVideoPath}</p>` : ''}
                `;
            } catch (error) {
                document.getElementById('video-status').innerHTML = `<p>‚ùå Error checking video status: ${error.message}</p>`;
            }
        }

        async function viewVideoDetails(scriptId) {
            try {
                const response = await fetch(`${API_BASE}/scripts/${scriptId}`);
                const script = await response.json();
                
                if (!script.finalVideoPath) {
                    document.getElementById('video-status').innerHTML = `
                        <div class="status-warning">
                            <h4>‚ö†Ô∏è No Video Generated</h4>
                            <p>No video has been generated for script: ${scriptId}</p>
                            <p>Generate audio first, then create the video.</p>
                        </div>
                    `;
                    return;
                }
                
                const videoPath = script.finalVideoPath.replace(/\\/g, '/');
                const fileSizeMB = await getFileSize(script.finalVideoPath);
                
                document.getElementById('video-status').innerHTML = `
                    <div class="status-success">
                        <h4>üé• Video Details - ${script.id}</h4>
                        <div class="form-row">
                            <span><strong>üìÅ File:</strong> ${videoPath}</span>
                            <span><strong>‚è±Ô∏è Duration:</strong> ${script.videoDuration ? script.videoDuration.toFixed(2) + 's' : 'Unknown'}</span>
                        </div>
                        <div class="form-row">
                            <span><strong>üë• Characters:</strong> ${script.selectedCharacters.join(', ')}</span>
                            <span><strong>üí¨ Lines:</strong> ${script.dialogue.length}</span>
                        </div>
                        <div class="form-row">
                            <span><strong>üéµ Audio:</strong> ${script.audioCount}/${script.dialogue.length} lines</span>
                            <span><strong>üìä Size:</strong> ${fileSizeMB}</span>
                        </div>
                        <p><strong>üìÖ Created:</strong> ${new Date(script.createdAt).toLocaleString()}</p>
                        <p><strong>üîÑ Updated:</strong> ${new Date(script.updatedAt).toLocaleString()}</p>
                        <p><strong>üí° Prompt:</strong> ${script.originalPrompt}</p>
                    </div>
                `;
                
                document.getElementById('video-controls').innerHTML = `
                    <button onclick="checkVideoStatus('${scriptId}')" class="warning">üìä Check Status</button>
                    <button onclick="listScripts()" class="success">üîÑ Refresh Scripts</button>
                `;
                
            } catch (error) {
                document.getElementById('video-status').innerHTML = `
                    <div class="status-error">
                        <h4>‚ùå Error Loading Video Details</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function getFileSize(filePath) {
            try {
                // This is a simplified approach - in a real app you'd have an API endpoint for file info
                return "~25MB"; // Based on the logs showing 25MB file
            } catch (error) {
                return "Unknown";
            }
        }

        // Script editing variables
        let currentEditingScript = null;
        let currentDialogue = [];

        async function editScript(scriptId) {
            try {
                // Fetch the script data
                const response = await safeFetch(`${API_BASE}/scripts/${scriptId}`);
                const script = await response.json();
                
                if (!response.ok) {
                    alert(`Failed to load script: ${script.detail}`);
                    return;
                }
                
                // Set up editing state
                currentEditingScript = script;
                currentDialogue = [...script.dialogue]; // Create a copy
                
                // Show the editor
                document.getElementById('script-editor').style.display = 'block';
                document.getElementById('editing-script-id').textContent = scriptId;
                
                // Populate the dialogue editor
                renderDialogueEditor();
                
                // Scroll to editor
                document.getElementById('script-editor').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                alert(`Error loading script for editing: ${error.message}`);
            }
        }

        function renderDialogueEditor() {
            const editorDiv = document.getElementById('script-dialogue-editor');
            editorDiv.innerHTML = '';
            
            currentDialogue.forEach((line, index) => {
                const lineDiv = document.createElement('div');
                lineDiv.className = 'dialogue-line-editor';
                lineDiv.innerHTML = `
                    <div class="form-row">
                        <select class="speaker-select" onchange="updateDialogueLine(${index}, 'speaker', this.value)">
                            ${availableCharacters.map(char => 
                                `<option value="${char.id}" ${char.id === line.speaker ? 'selected' : ''}>${char.displayName} (${char.id})</option>`
                            ).join('')}
                        </select>
                        <button onclick="moveLineUp(${index})" ${index === 0 ? 'disabled' : ''}>‚¨ÜÔ∏è</button>
                        <button onclick="moveLineDown(${index})" ${index === currentDialogue.length - 1 ? 'disabled' : ''}>‚¨áÔ∏è</button>
                        <button onclick="removeDialogueLine(${index})" class="danger">üóëÔ∏è</button>
                    </div>
                    <textarea class="dialogue-text-input" 
                              placeholder="Enter dialogue text..." 
                              onchange="updateDialogueLine(${index}, 'text', this.value)">${line.text}</textarea>
                    ${line.audioFile ? `<p><small>üéµ Audio: ${line.audioFile}</small></p>` : '<p><small>‚ùå No audio generated</small></p>'}
                `;
                editorDiv.appendChild(lineDiv);
            });
        }

        function updateDialogueLine(index, field, value) {
            if (currentDialogue[index]) {
                currentDialogue[index][field] = value;
                // Remove audio file reference if text changes (audio will need regeneration)
                if (field === 'text') {
                    currentDialogue[index].audioFile = null;
                }
            }
        }

        function addDialogueLine() {
            const newLine = {
                speaker: availableCharacters.length > 0 ? availableCharacters[0].id : 'unknown',
                text: '',
                audioFile: null
            };
            currentDialogue.push(newLine);
            renderDialogueEditor();
        }

        function removeDialogueLine(index) {
            if (currentDialogue.length > 1) {
                currentDialogue.splice(index, 1);
                renderDialogueEditor();
            } else {
                alert('Cannot remove the last dialogue line. Scripts must have at least one line.');
            }
        }

        function moveLineUp(index) {
            if (index > 0) {
                [currentDialogue[index], currentDialogue[index - 1]] = [currentDialogue[index - 1], currentDialogue[index]];
                renderDialogueEditor();
            }
        }

        function moveLineDown(index) {
            if (index < currentDialogue.length - 1) {
                [currentDialogue[index], currentDialogue[index + 1]] = [currentDialogue[index + 1], currentDialogue[index]];
                renderDialogueEditor();
            }
        }

        async function saveScriptChanges() {
            if (!currentEditingScript) {
                alert('No script is being edited');
                return;
            }
            
            // Validate dialogue
            for (let i = 0; i < currentDialogue.length; i++) {
                const line = currentDialogue[i];
                if (!line.text.trim()) {
                    alert(`Line ${i + 1} cannot be empty. Please enter dialogue text.`);
                    return;
                }
                if (!line.speaker) {
                    alert(`Line ${i + 1} must have a speaker selected.`);
                    return;
                }
            }
            
            try {
                document.getElementById('script-edit-result').innerHTML = '<div class="status-warning"><p>üíæ Saving script changes...</p></div>';
                
                const response = await safeFetch(`${API_BASE}/scripts/${currentEditingScript.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dialogue: currentDialogue })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('script-edit-result').innerHTML = `
                        <div class="status-success">
                            <h4>‚úÖ Script Updated Successfully!</h4>
                            <p>Updated script: ${result.id}</p>
                            <p>Lines: ${result.dialogue.length}</p>
                            <p>Note: Audio will need to be regenerated for modified lines.</p>
                        </div>
                    `;
                    
                    // Refresh scripts list and close editor
                    listScripts();
                    cancelScriptEdit();
                    
                } else {
                    document.getElementById('script-edit-result').innerHTML = `
                        <div class="status-error">
                            <h4>‚ùå Failed to Update Script</h4>
                            <p>${result.detail || 'Unknown error'}</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                document.getElementById('script-edit-result').innerHTML = `
                    <div class="status-error">
                        <h4>‚ùå Error Updating Script</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function cancelScriptEdit() {
            currentEditingScript = null;
            currentDialogue = [];
            document.getElementById('script-editor').style.display = 'none';
            document.getElementById('script-edit-result').innerHTML = '';
        }

        async function deleteScript(scriptId) {
            if (!confirm(`Are you sure you want to delete script ${scriptId}? This will also delete all associated audio and video files.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/scripts/${scriptId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ Script deleted successfully: ${result.message}`);
                    listScripts(); // Refresh the scripts list
                } else {
                    alert(`‚ùå Failed to delete script: ${result.detail}`);
                }
            } catch (error) {
                alert(`‚ùå Error deleting script: ${error.message}`);
            }
        }

        // Check system status on page load
        async function checkSystemStatus() {
            try {
                // Check API status
                const apiResponse = await fetch('/api/system/status');
                const apiStatus = await apiResponse.json();
                
                // Check F5-TTS status
                const f5ttsResponse = await fetch('/api/f5tts/status');
                const f5ttsStatus = await f5ttsResponse.json();
                
                // Check FFmpeg status
                const ffmpegResponse = await fetch('/api/system/ffmpeg-status');
                const ffmpegStatus = await ffmpegResponse.json();
                
                const statusHtml = `
                    <div style="background-color: #f0f8ff; padding: 10px; margin: 10px 0; border-radius: 5px;">
                        <h4>System Status</h4>
                        <p>üöÄ API: ${apiStatus.status} (${apiStatus.totalCharacters} characters)</p>
                        <p>üé§ F5-TTS: ${f5ttsStatus.status}</p>
                        <p>üé¨ FFmpeg: ${ffmpegStatus.status} - ${ffmpegStatus.message}</p>
                    </div>
                `;
                
                document.getElementById('systemStatus').innerHTML = statusHtml;
            } catch (error) {
                document.getElementById('systemStatus').innerHTML = `
                    <div style="background-color: #ffe6e6; padding: 10px; margin: 10px 0; border-radius: 5px;">
                        <h4>System Status</h4>
                        <p>‚ùå Error checking system status: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Initialize page
        window.onload = function() {
            console.log('üöÄ Initializing Character Management UI...');
            getSystemStatus();
            listCharacters();
            listScripts();
        };
    </script>
</body>
</html> 